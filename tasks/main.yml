---
# tasks file for ip-forwarder

- name: Install iptables-persistent apt packages
  become: true
  apt:
    update_cache: true
    name: iptables-persistent
    state: present

- name: Enable IPv4 forwarding
  become: true
  sysctl:
    name: net.ipv4.ip_forward
    value: 1
    sysctl_set: yes
    state: present
    reload: yes
  when: ipfwd.ipv4 is defined and ipfwd.ipv4

- name: Enable IPv6 forwarding
  become: true
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: 1
    sysctl_set: yes
    state: present
    reload: yes
  when: ipfwd.ipv6 is defined and ipfwd.ipv6

- name: Enable NAT
  become: true
  iptables:
    table: nat
    chain: POSTROUTING
    out_interface: "{{ ipfwd.wan }}"
    jump: MASQUERADE

- name: Persist IPv4 iptables rules
  become: true
  shell: iptables-save >/etc/iptables/rules.v4

- name: Persist IPv6 iptables rules
  become: true
  shell: ip6tables-save >/etc/iptables/rules.v6
